/*
 fusio
 Copyright (C) 2015-2016 Christoph Kappestein
 License: AGPLv3
*/
"use strict";function guessFusioEndpointUrl(){for(var url=window.location.href,removePart=function(url,sign){var count=(url.match(/\//g)||[]).length,pos=url.lastIndexOf(sign);return count>2&&-1!==pos?url.substring(0,pos):url},parts=["#","?","/"],i=0;i<parts.length;i++)url=removePart(url,parts[i]);return url+"/index.php/"}var fusioApp=angular.module("fusioApp",["ngRoute","ngSanitize","ui.bootstrap","ui.gravatar","satellizer","noCAPTCHA","fusioApp.app.developer","fusioApp.app.grant","fusioApp.auth","fusioApp.login","fusioApp.logout","fusioApp.profile","fusioApp.security","fusioApp.signup"]);if(fusioApp.value("version","v0.1"),fusioApp.config(["$routeProvider",function($routeProvider){$routeProvider.otherwise({redirectTo:"/login"})}]),fusioApp.factory("fusioAuthenticate",["SatellizerShared",function($auth){return{request:function(request){if($auth.isAuthenticated()){var payload=$auth.getPayload();payload&&payload.sub&&(request.headers.Authorization="Bearer "+payload.sub)}return request}}}]),fusioApp.config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("fusioAuthenticate")}]),fusioApp.run(function($rootScope,$window,$location,$http,version){$rootScope.version=version}),"undefined"==typeof fusio_url)var fusio_url=guessFusioEndpointUrl();angular.module("fusioApp.app.developer",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/app/developer",{templateUrl:"app/app/developer/developer.html",controller:"AppDeveloperCtrl"})}]).controller("AppDeveloperCtrl",["$scope","$http","$uibModal","$auth","$location",function($scope,$http,$uibModal,$auth,$location){return $scope.apps=[],$auth.isAuthenticated()?($scope.load=function(){$http.get(fusio_url+"consumer/app/developer").then(function(response){$scope.apps=response.data.entry})},$scope.createApp=function(){var modalInstance=$uibModal.open({size:"md",backdrop:"static",templateUrl:"app/app/developer/create.html",controller:"AppDeveloperCreateCtrl"});modalInstance.result.then(function(){$scope.load()},function(){})},$scope.showApp=function(app){$uibModal.open({size:"md",backdrop:"static",templateUrl:"app/app/developer/detail.html",controller:"AppDeveloperDetailCtrl",resolve:{app:function(){return app}}})},$scope.deleteApp=function(app){confirm("Do you really want to delete the app?")&&$http["delete"](fusio_url+"consumer/app/developer/"+app.id).then(function(){$scope.load()})},void $scope.load()):void $location.path("/login")}]).controller("AppDeveloperCreateCtrl",["$scope","$http","$uibModalInstance",function($scope,$http,$uibModalInstance){$scope.app={name:"",url:"",scopes:[]},$scope.scopes=[],$http.get(fusio_url+"consumer/scope").then(function(response){$scope.scopes=response.data.entry}),$scope.create=function(app){var data=angular.copy(app);data.scopes&&angular.isArray(data.scopes)&&(data.scopes=data.scopes.filter(function(value){return null!=value})),$http.post(fusio_url+"consumer/app/developer",data).then(function(response){$scope.response=response.data,response.data.success===!0&&$uibModalInstance.close()},function(response){$scope.response=response.data})},$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.closeResponse=function(){$scope.response=null}}]).controller("AppDeveloperDetailCtrl",["$scope","$http","$uibModalInstance","app",function($scope,$http,$uibModalInstance,app){$scope.app=app,$http.get(fusio_url+"consumer/app/developer/"+app.id).then(function(response){$scope.app=response.data}),$scope.close=function(){$uibModalInstance.dismiss("cancel")}}]),angular.module("fusioApp.app.grant",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/app/grant",{templateUrl:"app/app/grant/grant.html",controller:"AppGrantCtrl"})}]).controller("AppGrantCtrl",["$scope","$http","$uibModal","$auth","$location",function($scope,$http,$uibModal,$auth,$location){return $scope.grants=[],$auth.isAuthenticated()?void $http.get(fusio_url+"consumer/app/grant").then(function(response){$scope.grants=response.data.entry}):void $location.path("/login")}]),angular.module("fusioApp.auth",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/auth",{templateUrl:"app/auth/grant.html",controller:"AuthCtrl"})}]).controller("AuthCtrl",["$scope","$http","$auth","$location",function($scope,$http,$auth,$location){var params=$location.search(),responseType=params.response_type,clientId=params.client_id,redirectUri=params.redirect_uri,scope=params.scope,state=params.state;if("token"!=responseType&&"code"!=responseType)$scope.error="Invalid response type";else if(clientId)if(scope){if(!$auth.isAuthenticated()){var data={responseType:responseType,clientId:clientId,redirectUri:redirectUri,scope:scope,state:state},auth=btoa(JSON.stringify(data));return void $location.url("/login?auth="+auth)}$http.get(fusio_url+"consumer/app/meta?client_id="+encodeURIComponent(clientId)+"&scope="+encodeURIComponent(scope)).then(function(response){$scope.app=response.data},function(){$scope.error="Could not request app informations"})}else $scope.error="Scope missing";else $scope.error="Client id missing";$scope.submitAccess=function(allow){var data={responseType:responseType,clientId:clientId,redirectUri:redirectUri,scope:scope,state:state,allow:allow};$scope.error=null,$scope.info=null,$http.post(fusio_url+"consumer/authorize",data).then(function(response){""==response.data.redirectUri||"#"==response.data.redirectUri?(0==allow&&($scope.info="The access was denied. There is nothing more todo here."),$scope.response=response.data):location.href=response.data.redirectUri},function(response){$scope.error=response.data.message})}}]),angular.module("fusioApp.login",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/login",{templateUrl:"app/login/login.html",controller:"LoginCtrl"})}]).controller("LoginCtrl",["$scope","$http","$auth","$location","SatellizerConfig",function($scope,$http,$auth,$location,SatellizerConfig){return $scope.user={username:"",password:""},$auth.isAuthenticated()?void $location.path("/profile"):($scope.authenticate=function(provider){$auth.authenticate(provider)},$scope.isConfigured=function(provider){return SatellizerConfig.providers[provider]&&SatellizerConfig.providers[provider].clientId},$scope.closeResponse=function(){$scope.response=null},void($scope.login=function(user){$auth.login(JSON.stringify(user)).then(function(){var params=$location.search();if(params&&params.auth){var allowedParams={responseType:"response_type",clientId:"client_id",redirectUri:"redirect_uri",scope:"scope",state:"state"},data=JSON.parse(atob(params.auth)),parts=[];for(var key in allowedParams)data[key]&&parts.push(allowedParams[key]+"="+encodeURIComponent(data[key]));$location.url("/auth?"+parts.join("&"))}else location.reload()})["catch"](function(response){$scope.user.password="",$scope.response=response.data})}))}]),angular.module("fusioApp.logout",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/logout",{templateUrl:"app/logout/logout.html",controller:"LogoutCtrl"})}]).controller("LogoutCtrl",["$scope","$auth","$location",function($scope,$auth,$location){$auth.isAuthenticated()&&$auth.logout(),$location.url("/login")}]),angular.module("fusioApp.profile",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/profile",{templateUrl:"app/profile/profile.html",controller:"ProfileCtrl"})}]).controller("ProfileCtrl",["$scope","$http","$uibModal","$auth","$location",function($scope,$http,$uibModal,$auth,$location){return $scope.account={},$scope.email=null,$auth.isAuthenticated()?($scope.update=function(account){$http.put(fusio_url+"consumer/account",account).then(function(response){$scope.response=response.data,$scope.load()})},$scope.closeResponse=function(){$scope.response=null},$scope.load=function(){$http.get(fusio_url+"consumer/account").then(function(response){$scope.account=response.data,response.data.email&&($scope.email=response.data.email)},function(response){$scope.response=response.data})},void $scope.load()):void $location.path("/login")}]),angular.module("fusioApp.security",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/security",{templateUrl:"app/security/security.html",controller:"SecurityCtrl"})}]).controller("SecurityCtrl",["$scope","$http","$uibModal","$auth","$location",function($scope,$http,$uibModal,$auth,$location){return $scope.account={},$auth.isAuthenticated()?($scope.update=function(account){$http.put(fusio_url+"consumer/account/change_password",account).then(function(response){$scope.response=response.data},function(response){$scope.response=response.data})},void($scope.closeResponse=function(){$scope.response=null})):void $location.path("/login")}]),angular.module("fusioApp.signup",["ngRoute"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/signup",{templateUrl:"app/signup/signup.html",controller:"SignupCtrl"})}]).controller("SignupCtrl",["$scope","$http","$auth",function($scope,$http){$scope.user={name:"",email:"",password:"",passwordRepeat:"",captcha:""},$scope.register=function(user){var data=angular.copy(user);delete data.passwordRepeat,$http.post(fusio_url+"consumer/register",data).success(function(data){$scope.response=data}).error(function(data){$scope.user.password="",$scope.user.passwordRepeat="",$scope.response=data})},$scope.closeResponse=function(){$scope.response=null}}]);